---
title: "outputReport"
author: "Rita Sefraoui Tahiri"
date: "10/12/2019"
output: html_document
---

```{r setup, include=FALSE}

library(caret)
library(data.table)
library(ggforce)
library(ggplot2)
library(ggwordcloud)
library(kableExtra)
library(keras)
library(lexicon)
library(purrr)
library(quanteda)
library(RColorBrewer)
library(readr)
library(RSentiment)
library(rword2vec)
library(sentimentr)
library(sunscReen)
library(textstem)
library(text2vec)
library(tidytext)
library(tidyverse)
library(topicmodels)
library(wordcloud)
```

```{r}
setwd("../data")
sunscreen <-
  list.files(pattern = "*.csv") %>%
  map_df(~read_csv(.))

#preformating of the database

##lowercase
sunscreen$review<-sunscreen$review%>%tolower()
##factors
sunscreen[c(2:5,7:8,14, 16:23)] <- lapply(sunscreen[c(2:5,7:8,14, 16:23)], factor)
##renaming the levels
levels(sunscreen$productName) <- c(
  "Age Shield Sunblock SPF 45",
  "Anthelios Ultra Light SPF 60" ,
  "Anthelios XL, SPF 60+",
  "Botanical Tinted Mineral SPF 50",
  "Clear Face Break-Out SPF 30",
  "RESIST Super-Light Daily SPF 30",
  "Sunscreen Face Lotion SPF 50",
  "Super City Block Oil-Free SPF 40",
  "Super City Block SPF 25",
  "Ultra Sheer Dry-Touch SPF 55",
  "Ultra Sheer Dry-Touch SPF45",
  "UV Aqua Rich Watery SPF50+"
)

#vectors of brands and products that we will use
brands<-levels(sunscreen$brandName)%>%tolower()%>%c()
productnames<-levels(sunscreen$productName%>%as.factor())%>%tolower()%>%c()

#lemmatization based on dictionnary hash_lemmas
sunscreen$review<-lemmatize_strings(sunscreen$review, dictionary=hash_lemmas)
sunscreen$review<-tolower(sunscreen$review)
sunscreen$brandName<-tolower(sunscreen$brandName)
sunscreen$productName<-tolower(sunscreen$productName)

#We put as stopwords common english words as well as the names of the brands and products 
my_stop_words <- c(word = c("#", "s", "ve", "re", "skin", "sunscreen", "product","spf", brands, productnames, "shield",
                            "sunscreen","sunscreens","t","it","It","use"), c(stopwords::stopwords("en")))%>%as_tibble()
my_stop_words$word<-my_stop_words$value

#We create a review2 column that remains untouched and we tokenize review
#We then take away the stop words

sunscreen_cleaned <- sunscreen %>%
  mutate(review2 = review) %>%
  as.tibble() %>%
  unnest_tokens(word, review) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(my_stop_words, by = "word") %>%
  filter(is.na(as.numeric(word)))

#tf-idf: we want to see if some words look specific to a review or to a product. 
tf_byreview<- sunscreen_cleaned %>%
  group_by(reviewId) %>%
  count(word) %>%
  ungroup()

tfidf_byreview<-tf_byreview%>%
  tidytext::bind_tf_idf(word, reviewId, n )

tfidf_byreview%>%
  dplyr::arrange(desc(tf_idf))%>%
  head()%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = FALSE)

tf_byproduct <- sunscreen_cleaned %>%
  group_by(productName) %>%
  count(word) %>%
  ungroup()

tfidf_product<-tf_byproduct%>%
  bind_tf_idf(word, productName, n )

tfidf_product%>%
  dplyr::arrange(desc(tf_idf))%>%
  head()%>%
  kable()%>%
  kable_styling(bootstrap_options = c("striped", "hover","condensed"), full_width = FALSE)
```


```{r, warning= FALSE}
#Sentiments wuth valence shifters

for (i in c(1:length(sunscreen$review))){
  sunscreen$sentiments[i]<-sentiment_by(sunscreen$review[i],
                                        hash_valence_shifters)
}

sunscreen$sentiments<-sunscreen$sentiments%>%
  as.numeric()

sentiment_valence_shifter_bybrand<-sunscreen%>%
  group_by(brandName)%>%
  mutate(sentimentbybrand=mean(sentiment))

sentiment_valence_shifter_byproduct<-sentiment_valence_shifter%>%
  group_by(productName)%>%
  mutate(sentimentbyproduct=mean(sentiment))


par(mfrow=c(3,3))

for (i in brands){
  x<-sentiment_valence_shifter_bybrand%>%
    filter(brandName==i)
  #summary(x$sentiment)%>%print()
  boxplot(x$sentiments)
}

for (i in productnames){
  y<-sentiment_valence_shifter_byproduct%>%
    filter(productName==i)
  #summary(x$sentiment)%>%print()
  boxplot(x$sentiments)
}
```



```{r}

###FIRST ANALYSIS => PUT SPF out

spf<-str_extract_all(sunscreen$productName, "\\d+")%>%
  as.data.frame()%>%
  t()

sunscreen<-cbind(sunscreen, spf)

par(mfrow=c(1,1))


#Try per brand

my_stop_words<-as_tibble(my_stop_words)
my_stop_words$word<-my_stop_words$value

sunscreen_cleaned_for_wordcloud <- sunscreen %>%
  dplyr::mutate(review2 = review) %>%
  dplyr::group_by(brandName)%>%
  as.tibble() %>%
  tidytext::unnest_tokens(word, review) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(my_stop_words, by = "word") %>%
  dplyr::filter(is.na(as.numeric(word)))

#Sentiment analysis by brand

#sentiment with nrc: these are by products
sentiment_by_brand.2 <- sunscreen_cleaned_for_wordcloud %>%
  inner_join(get_sentiments("nrc"), by = "word") %>%
  group_by(brandName, sentiment) %>%
  count()

sentiment_by_brand_sun<-sunscreen_cleaned_for_wordcloud %>%
  inner_join(sunscReen::get_sunsentiments("sunscReen"), by="word") %>%
  group_by(brandName, sentiment) %>%
  count()

sentiment_normalized_perbrand_sun<-sentiment_by_brand_sun%>%
  group_by(brandName)%>%
  mutate(norm=n/sum(n))

sentiment_normalized_perbrand<-sentiment_by_brand.2%>%
  group_by(brandName)%>%
  mutate(norm=n/sum(n))


plot_sentiment_page.2 <- function(p){
  ggplot(sentiment_by_brand.2, aes(x = sentiment, y = n, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ brandName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_pagenormalized.2 <- function(p){
  ggplot(sentiment_normalized_perbrand, aes(x = sentiment, y = norm, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ brandName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_page_sun <- function(p){
  ggplot(sentiment_by_brand_sun, aes(x = sentiment, y = n, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ brandName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_pagenormalized_sun<- function(p){
  ggplot(sentiment_normalized_perbrand_sun, aes(x = sentiment, y = norm, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ brandName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_page.2(1)%>%plot()
plot_sentiment_pagenormalized.2(1)%>%plot()

plot_sentiment_page_sun(1)%>%plot()
plot_sentiment_pagenormalized_sun(1)%>%plot()

###############################################################

#modify sentiments per product too with new

sunscreen_cleaned_for_wordcloud_product <- sunscreen %>%
  dplyr::mutate(review2 = review) %>%
  dplyr::group_by(productName)%>%
  as.tibble() %>%
  tidytext::unnest_tokens(word, review) %>%
  anti_join(stop_words, by = "word") %>%
  anti_join(my_stop_words, by = "word") %>%
  dplyr::filter(is.na(as.numeric(word)))

sentiment_by_brand_product.2 <- sunscreen_cleaned_for_wordcloud_product %>%
  inner_join(get_sentiments("nrc"), by = "word") %>%
  group_by(productName, sentiment) %>%
  count()

sentiment_by_brand_sun_product<-sunscreen_cleaned_for_wordcloud_product %>%
  inner_join(sunscReen::get_sunsentiments("sunscReen"), by="word") %>%
  group_by(productName, sentiment) %>%
  count()

sentiment_normalized_perbrand_sun_product<-sentiment_by_brand_sun_product%>%
  group_by(productName)%>%
  mutate(norm=n/sum(n))

sentiment_normalized_perbrand_product<-sentiment_by_brand_product.2%>%
  group_by(productName)%>%
  mutate(norm=n/sum(n))


plot_sentiment_page_product.2 <- function(p){
  ggplot(sentiment_by_brand_product.2, aes(x = sentiment, y = n, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ productName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_pagenormalized_product.2 <- function(p){
  ggplot(sentiment_normalized_perbrand_product, aes(x = sentiment, y = norm, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ productName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_page_sun_product <- function(p){
  ggplot(sentiment_by_brand_sun_product, aes(x = sentiment, y = n, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ productName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_pagenormalized_sun_product<- function(p){
  ggplot(sentiment_normalized_perbrand_sun_product, aes(x = sentiment, y = norm, fill = sentiment)) +
    geom_bar(stat = "identity") +
    ggforce::facet_wrap_paginate(facets = ~ productName, nrow = 3, ncol = 3, page = p) +
    theme_bw()+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    labs(x = "", y = "Number of words", fill = "Sentiment")
}

plot_sentiment_page_product.2(1)%>%plot()
plot_sentiment_pagenormalized_product.2(1)%>%plot()

plot_sentiment_page_sun_product(1)%>%plot()
plot_sentiment_pagenormalized_sun_product(1)%>%plot()


```


